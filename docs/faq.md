# 常见问题

整理训练与评估过程中遇到的高频问题，并结合仓库实现给出排查思路。

## 1. 训练相关

**Q：损失突然变大或出现 NaN？**  
A：检查学习率是否超过 `1e-4`，尝试降低 `lr_max`；确认输入数据无 NaN/Inf；关闭 AMP 复测；必要时减小 Batch Size。

**Q：PSNR/SSIM 长期不提升？**  
A：验证数据归一化是否一致（`coord_range`、`transpose_*`）；适度增加 `ddim_steps` 或切换 `simple_var=false`；确保训练集覆盖足够多样性。

**Q：显存不足？**  
A：降低 `batch_size`、关闭 `use_tfm_channels`、减小模型通道数；或将 `amp` 设为 false 并累积梯度（需要在脚本中实现）。

## 2. 数据准备

**Q：`KeyError: HDF5 文件缺少分组`？**  
A：确认文件中存在配置指定的 `TFM` 与 `hr` 分组；使用 `h5dump` 或自写脚本检查。

**Q：读入图像方向不对？**  
A：尝试切换 `transpose_lr/hr`；若源数据来自 MATLAB，通常需要转置一次。

**Q：多频数据怎么组织？**  
A：在 HDF5 中为每个样本保存 `(6, H, W)`（Real/Imag × 3 频段），并在配置中开启 `use_tfm_channels`。

## 3. 推理解读

**Q：DDIM 输出和训练时预览差异大？**  
A：训练阶段使用的是 DDPM 噪声注入，推理若使用 DDIM 并设 `eta=0` 会更加平滑；可尝试增加步数或切换至 DDPM。

**Q：指标不稳定或不可复现？**  
A：固定 `seed`，同时将 `sampler.eta` 调为 0 获取确定性输出；记录评估权重与配置快照。

**Q：输出偏白/黑？**  
A：检查是否启用了 VAE 且权重匹配；或者确认 `sampler.threshold` 未设过大（建议 0.01~0.1 之间微调）。

## 4. 框架拓展

**Q：如何扩展自定义骨干？**  
A：在 `network.py` 中新增 `nn.Module`，并将其配置写入 `MODEL_CONFIGS`（训练）与 `MODEL_REGISTRY`（评估），即可在 JSON 中切换。

**Q：想要更快推理怎么办？**  
A：减小 `ddim_steps`（如 10）；或对 `eval.py` 增加批量评估逻辑；另可尝试导出为 ONNX/TensorRT。

**Q：是否可以融入物理正向模型？**  
A：可以在自定义采样器中融合正向算子或梯度信息，例如在每步迭代时加入校正项；目前脚本提供基础接口，需自行扩展。

遇到新问题时，请补充到本节，并在《实验记录与结果》中注明关联实验。
